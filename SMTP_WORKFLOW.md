# SMTP Configuration and Mailing Workflow

## UI Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Club Manager Main Window                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Tabs: [Membres] [Postes] [Clubs MJC] [Exports] [Mailing] ...  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Membres Tab       â”‚                    â”‚    Mailing Tab       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     â”‚                    â”‚ [âš™ Configuration     â”‚
â”‚ [Ajouter]           â”‚                    â”‚  SMTP]               â”‚
â”‚ [Modifier]          â”‚                    â”‚                      â”‚
â”‚ [Supprimer]         â”‚   Click "Ouvrir"   â”‚ Help text: ğŸ“§ Mail   â”‚
â”‚ [Exporter]          â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ groupÃ© avec batch    â”‚
â”‚ [Ouvrir Mailing] â”€â”€â”€â”˜                    â”‚                      â”‚
â”‚                     â”‚                    â”‚ [SÃ©lection           â”‚
â”‚ Member list...      â”‚                    â”‚  destinataires]      â”‚
â”‚                     â”‚                    â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚ Objet: [________]    â”‚
                                           â”‚                      â”‚
                                           â”‚ Corps:               â”‚
                                           â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                                           â”‚ â”‚                 â”‚ â”‚
                                           â”‚ â”‚                 â”‚ â”‚
                                           â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                           â”‚                      â”‚
                                           â”‚ [PrÃ©visualiser]      â”‚
                                           â”‚ [Envoyer]            â”‚
                                           â”‚                      â”‚
                                           â”‚ Progress: [======   ]â”‚
                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
                                                     â”‚ Click âš™
                                                     â–¼
                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                           â”‚ SMTP Settings Dialog â”‚
                                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                           â”‚ Serveur SMTP         â”‚
                                           â”‚ â”œâ”€ HÃ´te: [______]    â”‚
                                           â”‚ â”œâ”€ Port: [587   ]    â”‚
                                           â”‚ â””â”€ SÃ©curitÃ©: [â–¼]     â”‚
                                           â”‚                      â”‚
                                           â”‚ Authentification     â”‚
                                           â”‚ â”œâ”€ User: [______]    â”‚
                                           â”‚ â””â”€ Pass: [â€¢â€¢â€¢â€¢â€¢â€¢]    â”‚
                                           â”‚                      â”‚
                                           â”‚ ExpÃ©diteur           â”‚
                                           â”‚ â”œâ”€ Email: [_____]    â”‚
                                           â”‚ â”œâ”€ Nom: [______]     â”‚
                                           â”‚ â””â”€ Reply: [_____]    â”‚
                                           â”‚                      â”‚
                                           â”‚ ParamÃ¨tres d'envoi   â”‚
                                           â”‚ â”œâ”€ Lot: [10    ]     â”‚
                                           â”‚ â”œâ”€ DÃ©lai: [1000]ms   â”‚
                                           â”‚ â”œâ”€ Retry: [2   ]     â”‚
                                           â”‚ â””â”€ [âœ“] Logs          â”‚
                                           â”‚                      â”‚
                                           â”‚ âš ï¸ SÃ©curitÃ©:          â”‚
                                           â”‚ APP_SECRET_KEY...    â”‚
                                           â”‚                      â”‚
                                           â”‚ [Tester connexion]   â”‚
                                           â”‚ [Envoyer test]       â”‚
                                           â”‚                      â”‚
                                           â”‚     [OK] [Annuler]   â”‚
                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Database Schema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          settings               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ key TEXT PRIMARY KEY            â”‚
â”‚ value TEXT                      â”‚
â”‚ updated_at TEXT                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ smtp_host                       â”‚
â”‚ smtp_port                       â”‚
â”‚ smtp_security                   â”‚
â”‚ smtp_username                   â”‚
â”‚ smtp_password (encrypted)       â”‚
â”‚ smtp_from                       â”‚
â”‚ smtp_reply_to                   â”‚
â”‚ smtp_sender_name                â”‚
â”‚ smtp_batch_size                 â”‚
â”‚ smtp_batch_delay                â”‚
â”‚ smtp_max_retries                â”‚
â”‚ smtp_enable_logging             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        mailing_logs             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id INTEGER PRIMARY KEY          â”‚
â”‚ recipient_id INTEGER FK         â”‚
â”‚ recipient_email TEXT            â”‚
â”‚ subject TEXT                    â”‚
â”‚ status TEXT (sent/failed)       â”‚
â”‚ message_id TEXT                 â”‚
â”‚ error TEXT                      â”‚
â”‚ timestamp TEXT                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Sending Workflow

```
User clicks "Envoyer"
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Validate form fields    â”‚
â”‚ - Subject not empty     â”‚
â”‚ - Body not empty        â”‚
â”‚ - Recipients selected   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check SMTP config       â”‚
â”‚ - Load from database    â”‚
â”‚ - Decrypt password      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ No config? â”€â”€â”€â”€â”€â”€â–º Show error + link to settings
        â”‚
        â–¼ Config OK
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Confirmation dialog     â”‚
â”‚ "Send to X recipients?" â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ User confirms
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Initialize SMTPSender   â”‚
â”‚ - Connect to server     â”‚
â”‚ - Authenticate          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Send in batches                 â”‚
â”‚ For each batch (size N):        â”‚
â”‚   For each recipient:           â”‚
â”‚     - Create EmailMessage       â”‚
â”‚     - Try to send (with retry)  â”‚
â”‚     - Log result                â”‚
â”‚     - Update progress bar       â”‚
â”‚   Sleep delay_ms between batchesâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Show results dialog     â”‚
â”‚ - X sent successfully   â”‚
â”‚ - Y failed              â”‚
â”‚ - Details of failures   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Security Flow

```
User enters password
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SMTPConfig.encrypt()     â”‚
â”‚ - Get APP_SECRET_KEY     â”‚
â”‚ - Derive Fernet key      â”‚
â”‚ - Encrypt password       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Save to database         â”‚
â”‚ INSERT INTO settings     â”‚
â”‚ (key, value)             â”‚
â”‚ ('smtp_password',        â”‚
â”‚  'gAAAAAB...')           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ Later when sending...
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Load from database       â”‚
â”‚ SELECT value FROM        â”‚
â”‚ settings WHERE           â”‚
â”‚ key='smtp_password'      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SMTPConfig.decrypt()     â”‚
â”‚ - Get APP_SECRET_KEY     â”‚
â”‚ - Derive Fernet key      â”‚
â”‚ - Decrypt password       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
    Use for SMTP auth
```

## Error Handling

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Possible Errors & Handling             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚ 1. SMTP Not Configured                 â”‚
â”‚    â”œâ”€â–º Show warning dialog             â”‚
â”‚    â””â”€â–º Offer to open settings          â”‚
â”‚                                        â”‚
â”‚ 2. Connection Failed                   â”‚
â”‚    â”œâ”€â–º Show error message              â”‚
â”‚    â”œâ”€â–º Display error details           â”‚
â”‚    â””â”€â–º Suggest checking settings       â”‚
â”‚                                        â”‚
â”‚ 3. Authentication Failed               â”‚
â”‚    â”œâ”€â–º Show clear error                â”‚
â”‚    â””â”€â–º Suggest password update         â”‚
â”‚                                        â”‚
â”‚ 4. Send Failure (per recipient)        â”‚
â”‚    â”œâ”€â–º Retry up to max_retries         â”‚
â”‚    â”œâ”€â–º Log to mailing_logs             â”‚
â”‚    â””â”€â–º Include in failure report       â”‚
â”‚                                        â”‚
â”‚ 5. Partial Batch Failure               â”‚
â”‚    â”œâ”€â–º Continue with next batch        â”‚
â”‚    â””â”€â–º Report all results at end       â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  club_manager/                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  core/                                               â”‚
â”‚  â”œâ”€ smtp_util.py                                     â”‚
â”‚  â”‚  â”œâ”€ SMTPConfig (encryption, config mgmt)         â”‚
â”‚  â”‚  â”œâ”€ SMTPSender (sending logic, batching, retry)  â”‚
â”‚  â”‚  â”œâ”€ get_smtp_config_from_db()                    â”‚
â”‚  â”‚  â””â”€ save_smtp_config_to_db()                     â”‚
â”‚  â”‚                                                   â”‚
â”‚  â”œâ”€ database.py                                      â”‚
â”‚  â”‚  â”œâ”€ setup_schema() [+settings, +mailing_logs]    â”‚
â”‚  â”‚  â””â”€ migrate_schema()                             â”‚
â”‚  â”‚                                                   â”‚
â”‚  â””â”€ [other core modules...]                         â”‚
â”‚                                                      â”‚
â”‚  ui/                                                 â”‚
â”‚  â”œâ”€ smtp_settings_dialog.py                         â”‚
â”‚  â”‚  â””â”€ SMTPSettingsDialog (UI for SMTP config)     â”‚
â”‚  â”‚                                                   â”‚
â”‚  â”œâ”€ mailing_tab.py                                   â”‚
â”‚  â”‚  â””â”€ MailingTab [+SMTP button, +progress bar]    â”‚
â”‚  â”‚                                                   â”‚
â”‚  â”œâ”€ members_tab.py                                   â”‚
â”‚  â”‚  â””â”€ MembersTab [modified mailing button]        â”‚
â”‚  â”‚                                                   â”‚
â”‚  â””â”€ [other UI modules...]                           â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     tests/                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  test_smtp_util.py                                   â”‚
â”‚  â”œâ”€ TestSMTPConfig (encryption tests)                â”‚
â”‚  â”œâ”€ TestSMTPSender (connection, sending tests)       â”‚
â”‚  â””â”€ TestSMTPConfigDatabase (persistence tests)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
